<!-- Edit Post Modal -->
<div id="editModal" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-80 transition-opacity backdrop-filter backdrop-blur-sm"
        onclick="closeEditModal()"></div>

    <!-- Modal Panel -->
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div
            class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">

            <!-- Header -->
            <div class="bg-gradient-to-r from-orange-500 to-red-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-edit mr-2"></i> Chỉnh sửa tin đăng
                </h3>
                <button type="button" onclick="closeEditModal()" class="text-white hover:text-gray-200 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Form -->
            <form id="editPostForm" class="p-6 space-y-6">
                <input type="hidden" id="edit_post_id" name="post_id">

                <!-- Title -->
                <div class="relative">
                    <input type="text" id="edit_title" name="title"
                        class="block rounded-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 border border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-orange-600 peer"
                        placeholder=" " required />
                    <label for="edit_title"
                        class="absolute text-sm text-gray-500 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-2.5 peer-focus:text-orange-600 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4">
                        Tiêu đề
                    </label>
                </div>

                <!-- Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Loại tin</label>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="item_type" value="Lost" id="edit_type_lost"
                                class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-700">Mất đồ</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="item_type" value="Found" id="edit_type_found"
                                class="w-4 h-4 text-green-600 focus:ring-green-500">
                            <span class="ml-2 text-sm text-gray-700">Nhặt được</span>
                        </label>
                    </div>
                </div>

                <!-- Category -->
                <div class="relative">
                    <select id="edit_category" name="category"
                        class="block rounded-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 border border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-orange-600 peer"
                        required>
                        <option value="">-- Chọn danh mục --</option>
                        <option value="Thẻ sinh viên">Thẻ sinh viên</option>
                        <option value="Ví">Ví</option>
                        <option value="Điện thoại">Điện thoại</option>
                        <option value="Laptop">Laptop</option>
                        <option value="Chìa khóa">Chìa khóa</option>
                        <option value="Trang phục">Trang phục</option>
                        <option value="Khác">Khác</option>
                    </select>
                    <label for="edit_category"
                        class="absolute text-sm text-gray-500 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-2.5 peer-focus:text-orange-600">
                        Danh mục
                    </label>
                </div>

                <!-- Date & Time -->
                <div class="relative">
                    <input type="datetime-local" id="edit_incident_date" name="incident_date"
                        class="block rounded-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 border border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-orange-600 peer"
                        required />
                    <label for="edit_incident_date"
                        class="absolute text-sm text-gray-500 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-2.5 peer-focus:text-orange-600">
                        Thời gian xảy ra
                    </label>
                </div>

                <!-- Location -->
                <div class="relative">
                    <input type="text" id="edit_location" name="location"
                        class="block rounded-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 border border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-orange-600 peer"
                        placeholder=" " required />
                    <label for="edit_location"
                        class="absolute text-sm text-gray-500 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-2.5 peer-focus:text-orange-600 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4">
                        Vị trí (Tòa nhà, khu vực)
                    </label>
                </div>

                <!-- Specific Location -->
                <div class="relative">
                    <input type="text" id="edit_specific_location" name="specific_location"
                        class="block rounded-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 border border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-orange-600 peer"
                        placeholder=" " />
                    <label for="edit_specific_location"
                        class="absolute text-sm text-gray-500 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-2.5 peer-focus:text-orange-600 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4">
                        Vị trí cụ thể (Phòng, tầng...)
                    </label>
                </div>

                <!-- Description -->
                <div class="relative">
                    <textarea id="edit_description" name="description" rows="4"
                        class="block rounded-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 border border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-orange-600 peer"
                        placeholder=" " required></textarea>
                    <label for="edit_description"
                        class="absolute text-sm text-gray-500 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-2.5 peer-focus:text-orange-600 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4">
                        Mô tả chi tiết
                    </label>
                </div>

                <!-- Contact Info -->
                <div class="relative">
                    <input type="text" id="edit_contact_info" name="contact_info"
                        class="block rounded-lg px-2.5 pb-2.5 pt-5 w-full text-sm text-gray-900 bg-gray-50 border border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-orange-600 peer"
                        placeholder=" " required />
                    <label for="edit_contact_info"
                        class="absolute text-sm text-gray-500 duration-300 transform -translate-y-4 scale-75 top-4 z-10 origin-[0] left-2.5 peer-focus:text-orange-600 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-4">
                        Thông tin liên hệ (SĐT/FB)
                    </label>
                </div>

                <!-- Images Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Cập nhật hình ảnh (Tùy chọn - Tối đa 5)
                    </label>
                    <div class="flex items-center justify-center w-full">
                        <label for="edit_images"
                            class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 hover:border-orange-500 transition-colors">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-500"><span class="font-semibold">Bấm để tải</span> hoặc kéo
                                    thả</p>
                                <p class="text-xs text-gray-500">PNG, JPG, GIF (Max 5MB mỗi ảnh)</p>
                            </div>
                            <input id="edit_images" name="images" type="file" class="hidden" multiple accept="image/*"
                                onchange="previewEditImages(this)" />
                        </label>
                    </div>
                    <div id="edit_image_preview" class="grid grid-cols-3 gap-2 mt-4"></div>
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-info-circle"></i> Nếu không chọn ảnh mới, ảnh cũ sẽ được giữ nguyên
                    </p>
                </div>

                <!-- Submit Button -->
                <div class="flex gap-3">
                    <button type="submit" id="editSubmitBtn"
                        class="flex-1 text-white bg-orange-600 hover:bg-orange-700 focus:ring-4 focus:outline-none focus:ring-orange-300 font-medium rounded-lg text-sm px-5 py-3 text-center transition flex items-center justify-center">
                        <span id="editBtnText">Cập nhật</span>
                        <i id="editBtnIcon" class="fas fa-save ml-2"></i>
                        <svg id="editBtnLoading" class="hidden animate-spin ml-2 h-5 w-5 text-white"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                    </button>
                    <button type="button" onclick="closeEditModal()"
                        class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        Hủy
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openEditModal(postId) {
        console.log('[EditModal] Opening for Post ID:', postId);

        // Show modal
        document.getElementById('editModal').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

        // Fetch post data
        console.log('[EditModal] Fetching data from /api/posts/' + postId);
        fetch(`/api/posts/${postId}`)
            .then(res => {
                console.log('[EditModal] Response status:', res.status);
                return res.json();
            })
            .then(response => {
                console.log('[EditModal] Response data:', response);
                if (response.success) {
                    const post = response.data;
                    console.log('[EditModal] Post data:', post);

                    // Fill form
                    document.getElementById('edit_post_id').value = post.id;
                    document.getElementById('edit_title').value = post.title;
                    document.getElementById('edit_category').value = post.category || '';
                    document.getElementById('edit_location').value = post.location;
                    document.getElementById('edit_specific_location').value = post.specific_location || '';
                    document.getElementById('edit_description').value = post.description;
                    document.getElementById('edit_contact_info').value = post.contact_info;

                    // Set radio button
                    if (post.item_type === 'Lost') {
                        document.getElementById('edit_type_lost').checked = true;
                    } else {
                        document.getElementById('edit_type_found').checked = true;
                    }

                    // Set datetime (convert from server format)
                    if (post.incident_date) {
                        const date = new Date(post.incident_date);
                        const formatted = date.toISOString().slice(0, 16);
                        document.getElementById('edit_incident_date').value = formatted;
                    }

                    // Display existing images
                    const preview = document.getElementById('edit_image_preview');
                    preview.innerHTML = '';

                    // Store existing images globally
                    window.existingImages = post.images || [];
                    window.deletedImages = [];

                    if (post.images && post.images.length > 0) {
                        console.log('[EditModal] Existing images:', post.images);

                        post.images.forEach((imgUrl, index) => {
                            const getUrl = (path) => path.startsWith('http') ? path : `/static/${path.replace(/^static\//, '').replace(/^\/static\//, '')}`;
                            const div = document.createElement('div');
                            div.className = 'relative group';
                            div.dataset.imageUrl = imgUrl;
                            div.innerHTML = `
                                <img src="${getUrl(imgUrl)}" class="h-24 w-full object-cover rounded-lg border-2 border-blue-300">
                                <span class="absolute bottom-1 left-1 bg-blue-500 text-white text-xs px-2 py-0.5 rounded">Ảnh cũ</span>
                                <button type="button" onclick="deleteExistingImage('${imgUrl}', this)"
                                    class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            `;
                            preview.appendChild(div);
                        });
                    } else {
                        console.log('[EditModal] No existing images');
                    }
                } else {
                    console.error('[EditModal] Failed:', response.message);
                    alert('Không tìm thấy bài viết');
                    closeEditModal();
                }
            })
            .catch(err => {
                console.error('[EditModal] Error:', err);
                alert('Lỗi khi tải dữ liệu');
                closeEditModal();
            });
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        document.getElementById('editPostForm').reset();
        document.getElementById('edit_image_preview').innerHTML = '';
    }

    // Preview images
    let editSelectedFiles = [];

    function deleteExistingImage(imageUrl, button) {
        console.log('[EditModal] Deleting existing image:', imageUrl);

        // Add to deleted list
        if (!window.deletedImages.includes(imageUrl)) {
            window.deletedImages.push(imageUrl);
        }

        // Remove from DOM
        button.closest('.relative').remove();

        console.log('[EditModal] Deleted images:', window.deletedImages);
    }

    function previewEditImages(input) {
        const preview = document.getElementById('edit_image_preview');
        editSelectedFiles = Array.from(input.files);

        console.log('[EditModal] New images selected:', editSelectedFiles.length);

        // Remove old "new image" previews (keep existing images)
        const newImageDivs = preview.querySelectorAll('[data-new-image]');
        newImageDivs.forEach(div => div.remove());

        // Add new image previews
        editSelectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const div = document.createElement('div');
                div.className = 'relative group';
                div.dataset.newImage = 'true';
                div.innerHTML = `
                    <img src="${e.target.result}" class="h-24 w-full object-cover rounded-lg border-2 border-green-300">
                    <span class="absolute bottom-1 left-1 bg-green-500 text-white text-xs px-2 py-0.5 rounded">Ảnh mới</span>
                    <button type="button" onclick="removeEditImage(${index})"
                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                `;
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }

    function removeEditImage(index) {
        console.log('[EditModal] Removing new image at index:', index);
        editSelectedFiles.splice(index, 1);
        const dataTransfer = new DataTransfer();
        editSelectedFiles.forEach(file => dataTransfer.items.add(file));
        document.getElementById('edit_images').files = dataTransfer.files;
        previewEditImages(document.getElementById('edit_images'));
    }

    // Handle form submission
    document.getElementById('editPostForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const btn = document.getElementById('editSubmitBtn');
        const btnText = document.getElementById('editBtnText');
        const btnIcon = document.getElementById('editBtnIcon');
        const btnLoading = document.getElementById('editBtnLoading');

        // Loading state
        btn.disabled = true;
        btnText.textContent = 'Đang cập nhật...';
        btnIcon.classList.add('hidden');
        btnLoading.classList.remove('hidden');

        const formData = new FormData(this);
        const postId = document.getElementById('edit_post_id').value;

        // Replace images with selected files
        formData.delete('images');
        editSelectedFiles.forEach(file => {
            formData.append('images', file);
        });

        // Add deleted images list
        if (window.deletedImages && window.deletedImages.length > 0) {
            formData.append('deleted_images', JSON.stringify(window.deletedImages));
            console.log('[EditModal] Deleted images to send:', window.deletedImages);
        }

        console.log('[EditModal] Submitting to /post/edit/' + postId);
        console.log('[EditModal] Form data keys:', Array.from(formData.keys()));
        console.log('[EditModal] New images count:', editSelectedFiles.length);

        fetch(`/post/edit/${postId}`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(res => {
                console.log('[EditModal] Update response status:', res.status);
                return res.json();
            })
            .then(response => {
                console.log('[EditModal] Update response:', response);
                if (response.success) {
                    alert('Cập nhật thành công!');
                    window.location.reload();
                } else {
                    alert('Lỗi: ' + (response.message || 'Không thể cập nhật'));
                    // Reset button
                    btn.disabled = false;
                    btnText.textContent = 'Cập nhật';
                    btnIcon.classList.remove('hidden');
                    btnLoading.classList.add('hidden');
                }
            })
            .catch(err => {
                console.error('[EditModal] Update error:', err);
                alert('Lỗi kết nối');
                // Reset button
                btn.disabled = false;
                btnText.textContent = 'Cập nhật';
                btnIcon.classList.remove('hidden');
                btnLoading.classList.add('hidden');
            });
    });
</script>