{% extends "base.html" %}

{% block content %}
<!-- Search Header -->
<div class="text-center mb-10">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-4">Tìm Đồ Thất Lạc <span class="text-orange-600">FPTU</span>
    </h1>
    <p class="text-gray-600 mb-8">Kết nối cộng đồng, tìm lại đồ đã mất nhanh chóng.</p>

    <form action="{{ url_for('index') }}" method="GET"
        class="max-w-xl mx-auto flex shadow-md rounded-lg overflow-hidden">
        <input type="text" name="q" value="{{ query if query else '' }}"
            placeholder="Tìm kiếm (Chìa khóa, ví, thẻ xe...)"
            class="flex-grow px-6 py-3 border-none focus:outline-none">
        <button type="submit" class="bg-orange-600 text-white px-6 font-bold hover:bg-orange-700 transition">
            <i class="fas fa-search"></i>
        </button>
    </form>
</div>

<!-- Items Grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for item in items %}
    <div
        class="bg-white rounded-xl shadow hover:shadow-lg transition duration-300 overflow-hidden relative border border-gray-100 flex flex-col">
        <div class="p-6 flex-grow">
            <div class="flex justify-between items-start mb-4">
                <span
                    class="inline-block px-3 py-1 rounded-full text-xs font-semibold
                    {% if item.item_type == 'Lost' %} bg-red-100 text-red-600 {% else %} bg-green-100 text-green-600 {% endif %}">
                    {{ item.item_type }}
                </span>
                <span class="text-gray-400 text-xs"><i class="far fa-clock mr-1"></i> {{
                    item.date_posted.strftime('%d/%m %H:%M') }}</span>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-2 truncate">{{ item.title }}</h3>
            <p class="text-gray-600 text-sm mb-4 line-clamp-3">{{ item.description }}</p>

            <div class="flex items-center text-gray-500 text-sm mb-4">
                <i class="fas fa-map-marker-alt text-orange-500 mr-2"></i> {{ item.location }}
            </div>
        </div>

        <div class="px-6 py-4 bg-gray-50 border-t flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold">
                    {{ item.user.username[0].upper() }}
                </div>
                <span class="text-sm font-medium text-gray-700">{{ item.user.username }}</span>
            </div>

            <button
                onclick="openContactModal('{{ item.title }}', '{{ item.location }}', '{{ item.contact_info }}', '{{ item.user.username }}', '{{ item.user.id }}')"
                class="text-orange-600 hover:text-orange-800 font-semibold text-sm focus:outline-none">
                Liên hệ <i class="fas fa-chevron-right ml-1"></i>
            </button>
        </div>
    </div>
    {% else %}
    <div class="col-span-full text-center py-12">
        <div class="text-gray-400 text-6xl mb-4"><i class="fas fa-search"></i></div>
        <p class="text-xl text-gray-600">Không tìm thấy tin nào phù hợp.</p>
        <a href="{{ url_for('post_item') }}" class="text-orange-600 font-bold hover:underline mt-2 inline-block">Đăng
            tin ngay</a>
    </div>
    {% endfor %}
</div>

<!-- Modal -->
<div id="contactModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
            onclick="closeContactModal()"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-orange-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-address-card text-orange-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Thông tin liên hệ
                        </h3>
                        <div class="mt-4 space-y-3">
                            <p class="text-sm text-gray-500">Vật phẩm: <span id="modalItemTitle"
                                    class="font-bold text-gray-800"></span></p>
                            <p class="text-sm text-gray-500">Tại: <span id="modalItemLocation"
                                    class="font-bold text-gray-800"></span></p>

                            <div class="bg-gray-100 p-4 rounded-md mt-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide">Contact /
                                    SĐT</label>
                                <p id="modalContactInfo" class="text-xl font-bold text-orange-600 select-all"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse justify-between items-center">
                <div class="flex space-x-2">
                    {% if current_user.is_authenticated %}
                    <a id="modalChatLink" href="#"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-comment-dots mr-2 mt-1"></i> Chat Ngay
                    </a>
                    {% else %}
                    <a href="{{ url_for('login') }}"
                        class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Đăng nhập để chat
                    </a>
                    {% endif %}
                    <button type="button"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                        onclick="closeContactModal()">
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openContactModal(title, location, contact, username, userId) {
        document.getElementById('modalItemTitle').textContent = title;
        document.getElementById('modalItemLocation').textContent = location;
        document.getElementById('modalContactInfo').textContent = contact;

        const chatLink = document.getElementById('modalChatLink');
        if (chatLink) {
            chatLink.href = "/chat/" + userId;
        }

        document.getElementById('contactModal').classList.remove('hidden');
    }

    function closeContactModal() {
        document.getElementById('contactModal').classList.add('hidden');
    }
</script>
{% endblock %}