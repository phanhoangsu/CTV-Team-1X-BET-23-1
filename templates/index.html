{% extends "base.html" %}

{% block content %}
<!-- Search Header -->
<div class="text-center mb-10">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-4">Tìm Đồ Thất Lạc <span class="text-orange-600">FPTU</span>
    </h1>
    <p class="text-gray-600 mb-8">Kết nối cộng đồng, tìm lại đồ đã mất nhanh chóng.</p>

    <form action="{{ url_for('index') }}" method="GET"
        class="max-w-xl mx-auto flex shadow-md rounded-lg overflow-hidden">
        <input type="text" name="q" value="{{ query if query else '' }}"
            placeholder="Tìm kiếm (Chìa khóa, ví, thẻ xe...)"
            class="flex-grow px-6 py-3 border-none focus:outline-none">
        <button type="submit" class="bg-orange-600 text-white px-6 font-bold hover:bg-orange-700 transition">
            <i class="fas fa-search"></i>
        </button>
    </form>
</div>

<!-- Items Grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for item in items %}
    <div class="bg-white rounded-xl shadow hover:shadow-lg transition duration-300 overflow-hidden relative border border-gray-100 flex flex-col cursor-pointer item-card"
        data-item-id="{{ item.id }}">
        <!-- Image Section -->
        {% if item.images_list and item.images_list|length > 0 %}
        <div class="relative w-full h-48 bg-gray-200 overflow-hidden">
            <img src="{{ item.images_list[0] }}" alt="{{ item.title }}"
                class="w-full h-full object-cover hover:scale-105 transition-transform duration-300">
            {% if item.images_list|length > 1 %}
            <div
                class="absolute top-2 right-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded-full text-xs font-semibold">
                <i class="fas fa-images mr-1"></i>{{ item.images_list|length }}
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="relative w-full h-48 bg-gray-200 flex items-center justify-center">
            <i class="fas fa-image text-gray-400 text-4xl"></i>
        </div>
        {% endif %}

        <div class="p-6 flex-grow">
            <div class="flex justify-between items-start mb-4">
                <span
                    class="inline-block px-3 py-1 rounded-full text-xs font-semibold
                    {% if item.item_type == 'Lost' %} bg-red-100 text-red-600 {% else %} bg-green-100 text-green-600 {% endif %}">
                    {{ item.item_type }}
                </span>
                <span class="text-gray-400 text-xs"><i class="far fa-clock mr-1"></i> {{
                    to_vn_time(item.date_posted).strftime('%d/%m %H:%M') }}</span>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-2 truncate">{{ item.title }}</h3>
            <p class="text-gray-600 text-sm mb-4 line-clamp-3">{{ item.description }}</p>

            <div class="flex items-center text-gray-500 text-sm mb-4">
                <i class="fas fa-map-marker-alt text-orange-500 mr-2"></i> {{ item.location }}
            </div>
        </div>

        <div class="px-6 py-4 bg-gray-50 border-t flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold">
                    {{ item.user.username[0].upper() }}
                </div>
                <span class="text-sm font-medium text-gray-700">{{ item.user.username }}</span>
            </div>

            <button
                onclick="event.stopPropagation(); openContactModal('{{ item.title }}', '{{ item.location }}', '{{ item.contact_info }}', '{{ item.user.username }}', '{{ item.user.id }}')"
                class="text-orange-600 hover:text-orange-800 font-semibold text-sm focus:outline-none z-10 relative">
                Liên hệ <i class="fas fa-chevron-right ml-1"></i>
            </button>
        </div>
    </div>
    {% else %}
    <div class="col-span-full text-center py-12">
        <div class="text-gray-400 text-6xl mb-4"><i class="fas fa-search"></i></div>
        <p class="text-xl text-gray-600">Không tìm thấy tin nào phù hợp.</p>
        <a href="{{ url_for('post_item') }}" class="text-orange-600 font-bold hover:underline mt-2 inline-block">Đăng
            tin ngay</a>
    </div>
    {% endfor %}
</div>

<!-- Item Detail Modal -->
<div id="itemDetailModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="detail-modal-title"
    role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"
            onclick="closeItemDetailModal()"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full"
            onclick="event.stopPropagation()">
            <!-- Close Button -->
            <div class="absolute top-4 right-4 z-10">
                <button onclick="closeItemDetailModal(); event.stopPropagation();"
                    class="bg-white rounded-full p-2 shadow-lg hover:bg-gray-100">
                    <i class="fas fa-times text-gray-600"></i>
                </button>
            </div>

            <div class="bg-white">
                <!-- Image Gallery -->
                <div id="detailImageGallery" class="relative w-full h-[600px] bg-gray-200 overflow-hidden">
                    <div id="detailImageContainer" class="flex transition-transform duration-300 ease-in-out h-full">
                        <!-- Images will be inserted here -->
                    </div>
                    <!-- Navigation Arrows -->
                    <button id="prevImageBtn" onclick="changeDetailImage(-1)"
                        class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 z-10 hidden">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button id="nextImageBtn" onclick="changeDetailImage(1)"
                        class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 z-10 hidden">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <!-- Image Counter -->
                    <div id="imageCounter"
                        class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-60 text-white px-3 py-1 rounded-full text-sm z-10 hidden">
                        <span id="currentImageIndex">1</span> / <span id="totalImages">1</span>
                    </div>
                </div>

                <!-- Thumbnail Strip -->
                <div id="detailThumbnails" class="flex gap-2 p-4 bg-gray-50 overflow-x-auto border-b">
                    <!-- Thumbnails will be inserted here -->
                </div>

                <!-- Content -->
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span id="detailItemType"
                                    class="inline-block px-3 py-1 rounded-full text-xs font-semibold"></span>
                                <span class="text-gray-400 text-sm"><i class="far fa-clock mr-1"></i> <span
                                        id="detailDatePosted"></span></span>
                            </div>
                            <h2 id="detailTitle" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                            <p id="detailDescription" class="text-gray-600 mb-4"></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="flex items-start">
                            <i class="fas fa-map-marker-alt text-orange-500 mr-2 mt-1"></i>
                            <div>
                                <p class="text-xs text-gray-500 uppercase">Địa điểm</p>
                                <p id="detailLocation" class="text-gray-800 font-medium"></p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-user text-orange-500 mr-2 mt-1"></i>
                            <div>
                                <p class="text-xs text-gray-500 uppercase">Người đăng</p>
                                <p id="detailUsername" class="text-gray-800 font-medium"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                        <p class="text-xs text-gray-600 uppercase font-semibold mb-1">Thông tin liên hệ</p>
                        <p id="detailContactInfo" class="text-xl font-bold text-orange-600 select-all"></p>
                    </div>

                    <div class="flex gap-2">
                        {% if current_user.is_authenticated %}
                        <a id="detailChatLink" href="#"
                            class="flex-1 inline-flex justify-center items-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">
                            <i class="fas fa-comment-dots mr-2"></i> Chat Ngay
                        </a>
                        {% else %}
                        <a href="{{ url_for('login') }}"
                            class="flex-1 inline-flex justify-center items-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">
                            Đăng nhập để chat
                        </a>
                        {% endif %}
                        <button onclick="openContactModalFromDetail()"
                            class="flex-1 inline-flex justify-center items-center rounded-md border border-orange-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-orange-600 hover:bg-orange-50 focus:outline-none">
                            <i class="fas fa-phone mr-2"></i> Xem liên hệ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contact Modal -->
<div id="contactModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
            onclick="closeContactModal()"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-orange-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-address-card text-orange-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Thông tin liên hệ
                        </h3>
                        <div class="mt-4 space-y-3">
                            <p class="text-sm text-gray-500">Vật phẩm: <span id="modalItemTitle"
                                    class="font-bold text-gray-800"></span></p>
                            <p class="text-sm text-gray-500">Tại: <span id="modalItemLocation"
                                    class="font-bold text-gray-800"></span></p>

                            <div class="bg-gray-100 p-4 rounded-md mt-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide">Contact /
                                    SĐT</label>
                                <p id="modalContactInfo" class="text-xl font-bold text-orange-600 select-all"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse justify-between items-center">
                <div class="flex space-x-2">
                    {% if current_user.is_authenticated %}
                    <a id="modalChatLink" href="#"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-comment-dots mr-2 mt-1"></i> Chat Ngay
                    </a>
                    {% else %}
                    <a href="{{ url_for('login') }}"
                        class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Đăng nhập để chat
                    </a>
                    {% endif %}
                    <button type="button"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                        onclick="closeContactModal()">
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    console.log('=== SCRIPT BLOCK STARTED ===');

    // Ensure functions are available globally
    window.openItemDetailModal = null;
    window.closeItemDetailModal = null;
    console.log('Initialized window functions');

    // Store items data for modal
    console.log('Starting to build itemsData...');
    const itemsData = {
        {% for item in items %}
    { { item.id } }: {
        id: { { item.id } },
        title: { { item.title | tojson } },
        description: { { item.description | tojson } },
        location: { { item.location | tojson } },
        item_type: { { item.item_type | tojson } },
        contact_info: { { item.contact_info | tojson } },
        username: { { item.user.username | tojson } },
        user_id: { { item.user.id } },
        date_posted: "{{ to_vn_time(item.date_posted).strftime('%d/%m/%Y %H:%M') }}",
            images: { { item.images_list | tojson } }
    } {% if not loop.last %}, {% endif %}
    {% endfor %}
    };


    console.log('ItemsData loaded:', itemsData);
    console.log('ItemsData keys:', Object.keys(itemsData));
    console.log('ItemsData length:', Object.keys(itemsData).length);

    let currentDetailImageIndex = 0;
    let currentDetailItemId = null;

    // Define function in global scope
    console.log('Defining openItemDetailModal function...');
    window.openItemDetailModal = function (itemId) {
        console.log('=== openItemDetailModal CALLED ===');
        console.log('itemId:', itemId, 'Type:', typeof itemId);
        console.log('itemsData:', itemsData);
        console.log('Available itemsData keys:', Object.keys(itemsData));
        console.log('itemsData type:', typeof itemsData);

        // Convert itemId to number if it's a string
        const numericId = typeof itemId === 'string' ? parseInt(itemId) : itemId;
        const item = itemsData[numericId] || itemsData[itemId];

        if (!item) {
            console.error('Item not found:', itemId, 'Available items:', Object.keys(itemsData));
            alert('Không tìm thấy thông tin item. Vui lòng thử lại.');
            return;
        }

        console.log('Opening modal for item:', itemId, item);

        currentDetailItemId = numericId || itemId;
        currentDetailImageIndex = 0;

        try {
            // Set content
            const detailTitle = document.getElementById('detailTitle');
            const detailDescription = document.getElementById('detailDescription');
            const detailLocation = document.getElementById('detailLocation');
            const detailUsername = document.getElementById('detailUsername');
            const detailContactInfo = document.getElementById('detailContactInfo');
            const detailDatePosted = document.getElementById('detailDatePosted');

            if (!detailTitle || !detailDescription || !detailLocation) {
                console.error('Modal elements not found');
                return;
            }

            detailTitle.textContent = item.title || '';
            detailDescription.textContent = item.description || '';
            detailLocation.textContent = item.location || '';
            detailUsername.textContent = item.username || '';
            detailContactInfo.textContent = item.contact_info || '';
            detailDatePosted.textContent = item.date_posted || '';

            // Set item type badge
            const typeBadge = document.getElementById('detailItemType');
            if (typeBadge) {
                typeBadge.textContent = item.item_type || '';
                if (item.item_type === 'Lost') {
                    typeBadge.className = 'inline-block px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-600';
                } else {
                    typeBadge.className = 'inline-block px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-600';
                }
            }

            // Set chat link
            const chatLink = document.getElementById('detailChatLink');
            if (chatLink && item.user_id) {
                chatLink.href = "/chat/" + item.user_id;
            }

            // Render images - ensure images is an array
            const images = Array.isArray(item.images) ? item.images : (item.images ? [item.images] : []);
            console.log('Images to render:', images);
            renderDetailImages(images);

            // Show modal
            const modal = document.getElementById('itemDetailModal');
            if (!modal) {
                console.error('Modal element not found');
                return;
            }

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        } catch (error) {
            console.error('Error opening modal:', error);
            alert('Có lỗi xảy ra khi mở chi tiết. Vui lòng thử lại.');
        }
    };

    function renderDetailImages(images) {
        const container = document.getElementById('detailImageContainer');
        const thumbnails = document.getElementById('detailThumbnails');
        const prevBtn = document.getElementById('prevImageBtn');
        const nextBtn = document.getElementById('nextImageBtn');
        const counter = document.getElementById('imageCounter');
        const currentIndex = document.getElementById('currentImageIndex');
        const totalImages = document.getElementById('totalImages');

        container.innerHTML = '';
        thumbnails.innerHTML = '';

        // Debug: Log images array
        console.log('Rendering images:', images);
        console.log('Images length:', images ? images.length : 0);

        if (!images || images.length === 0) {
            container.innerHTML = '<div class="w-full h-full flex items-center justify-center"><i class="fas fa-image text-gray-400 text-6xl"></i></div>';
            prevBtn.classList.add('hidden');
            nextBtn.classList.add('hidden');
            counter.classList.add('hidden');
            return;
        }

        // Filter out any null/undefined/empty images
        const validImages = images.filter(img => img && img.trim() !== '');
        console.log('Valid images after filtering:', validImages.length);

        if (validImages.length === 0) {
            container.innerHTML = '<div class="w-full h-full flex items-center justify-center"><i class="fas fa-image text-gray-400 text-6xl"></i></div>';
            prevBtn.classList.add('hidden');
            nextBtn.classList.add('hidden');
            counter.classList.add('hidden');
            return;
        }

        // Render main images
        validImages.forEach((img, index) => {
            const imgDiv = document.createElement('div');
            imgDiv.className = 'min-w-full h-full flex items-center justify-center bg-gray-100';
            const imgElement = document.createElement('img');
            imgElement.src = img;
            imgElement.alt = `Image ${index + 1}`;
            imgElement.className = 'w-full h-full object-contain cursor-zoom-in';
            imgElement.onclick = () => window.open(img, '_blank');
            imgElement.onerror = function () {
                console.error('Failed to load image:', img);
                this.style.display = 'none';
            };
            imgDiv.appendChild(imgElement);
            container.appendChild(imgDiv);
        });

        // Render thumbnails
        validImages.forEach((img, index) => {
            const thumbDiv = document.createElement('div');
            thumbDiv.className = `flex-shrink-0 w-20 h-20 rounded-md overflow-hidden border-2 cursor-pointer transition-all ${index === 0 ? 'border-orange-500' : 'border-transparent'}`;
            thumbDiv.onclick = () => goToDetailImage(index);
            const thumbImg = document.createElement('img');
            thumbImg.src = img;
            thumbImg.alt = `Thumbnail ${index + 1}`;
            thumbImg.className = 'w-full h-full object-cover';
            thumbImg.onerror = function () {
                console.error('Failed to load thumbnail:', img);
                this.style.display = 'none';
            };
            thumbDiv.appendChild(thumbImg);
            thumbnails.appendChild(thumbDiv);
        });

        // Update counter
        totalImages.textContent = validImages.length;
        currentIndex.textContent = '1';

        // Show/hide navigation
        if (validImages.length > 1) {
            prevBtn.classList.remove('hidden');
            nextBtn.classList.remove('hidden');
            counter.classList.remove('hidden');
        } else {
            prevBtn.classList.add('hidden');
            nextBtn.classList.add('hidden');
            counter.classList.add('hidden');
        }

        updateDetailImage();
    }

    function changeDetailImage(direction) {
        const item = itemsData[currentDetailItemId];
        if (!item) return;

        const images = Array.isArray(item.images) ? item.images : (item.images ? [item.images] : []);
        if (images.length === 0) return;

        currentDetailImageIndex += direction;
        if (currentDetailImageIndex < 0) {
            currentDetailImageIndex = images.length - 1;
        } else if (currentDetailImageIndex >= images.length) {
            currentDetailImageIndex = 0;
        }

        goToDetailImage(currentDetailImageIndex);
    }

    function goToDetailImage(index) {
        const item = itemsData[currentDetailItemId];
        if (!item) return;

        const images = Array.isArray(item.images) ? item.images : (item.images ? [item.images] : []);
        if (images.length === 0) return;

        currentDetailImageIndex = Math.max(0, Math.min(index, images.length - 1));
        updateDetailImage();
    }

    function updateDetailImage() {
        const container = document.getElementById('detailImageContainer');
        const thumbnails = document.getElementById('detailThumbnails');
        const currentIndex = document.getElementById('currentImageIndex');

        if (!container) return;

        // Move main image
        container.style.transform = `translateX(-${currentDetailImageIndex * 100}%)`;

        // Update thumbnails
        const thumbElements = thumbnails.querySelectorAll('div');
        thumbElements.forEach((thumb, index) => {
            if (index === currentDetailImageIndex) {
                thumb.classList.remove('border-transparent');
                thumb.classList.add('border-orange-500');
            } else {
                thumb.classList.remove('border-orange-500');
                thumb.classList.add('border-transparent');
            }
        });

        // Update counter
        const item = itemsData[currentDetailItemId];
        if (item) {
            const images = Array.isArray(item.images) ? item.images : (item.images ? [item.images] : []);
            currentIndex.textContent = currentDetailImageIndex + 1;
        }
    }

    // Define close function in global scope
    window.closeItemDetailModal = function () {
        const modal = document.getElementById('itemDetailModal');
        if (modal) {
            modal.classList.add('hidden');
        }
        document.body.style.overflow = '';
    };

    // Also keep local reference for backward compatibility
    const closeItemDetailModal = window.closeItemDetailModal;

    // Keyboard navigation
    document.addEventListener('keydown', function (e) {
        const modal = document.getElementById('itemDetailModal');
        if (!modal.classList.contains('hidden')) {
            if (e.key === 'Escape') {
                closeItemDetailModal();
            } else if (e.key === 'ArrowLeft') {
                changeDetailImage(-1);
            } else if (e.key === 'ArrowRight') {
                changeDetailImage(1);
            }
        }
    });

    function openContactModal(title, location, contact, username, userId) {
        document.getElementById('modalItemTitle').textContent = title;
        document.getElementById('modalItemLocation').textContent = location;
        document.getElementById('modalContactInfo').textContent = contact;

        const chatLink = document.getElementById('modalChatLink');
        if (chatLink) {
            chatLink.href = "/chat/" + userId;
        }

        document.getElementById('contactModal').classList.remove('hidden');
    }

    function openContactModalFromDetail() {
        if (!currentDetailItemId) return;
        const item = itemsData[currentDetailItemId];
        if (!item) return;

        closeItemDetailModal();
        openContactModal(item.title, item.location, item.contact_info, item.username, item.user_id);
    }

    function closeContactModal() {
        document.getElementById('contactModal').classList.add('hidden');
    }

    // Add event listeners when DOM is ready
    console.log('Setting up DOMContentLoaded listener...');
    document.addEventListener('DOMContentLoaded', function () {
        console.log('=== DOMContentLoaded FIRED ===');

        // Add click listeners to all item cards
        const itemCards = document.querySelectorAll('.item-card');
        console.log('Found', itemCards.length, 'item cards');

        itemCards.forEach(function (card, index) {
            const itemId = card.getAttribute('data-item-id');
            console.log(`Card ${index}: itemId = ${itemId}`);

            card.addEventListener('click', function (e) {
                console.log('=== CARD CLICKED ===');
                console.log('Clicked element:', e.target);
                console.log('Card element:', this);
                console.log('Item ID from data:', this.getAttribute('data-item-id'));

                // Don't open modal if clicking on the contact button
                const contactButton = e.target.closest('button[onclick*="openContactModal"]');
                if (contactButton) {
                    console.log('Clicked on contact button, ignoring...');
                    return;
                }

                const itemId = parseInt(this.getAttribute('data-item-id'));
                console.log('Parsed itemId:', itemId);
                console.log('window.openItemDetailModal type:', typeof window.openItemDetailModal);

                if (itemId && window.openItemDetailModal) {
                    console.log('Calling openItemDetailModal with itemId:', itemId);
                    try {
                        window.openItemDetailModal(itemId);
                        console.log('openItemDetailModal called successfully');
                    } catch (error) {
                        console.error('Error calling openItemDetailModal:', error);
                        alert('Lỗi: ' + error.message);
                    }
                } else {
                    console.error('Cannot open modal - itemId:', itemId, 'function exists:', typeof window.openItemDetailModal);
                    alert('Lỗi: Không thể mở modal. itemId=' + itemId + ', function=' + typeof window.openItemDetailModal);
                }
            });
        });

        console.log('Event listeners attached to', itemCards.length, 'item cards');
        console.log('window.openItemDetailModal:', typeof window.openItemDetailModal);
    });

    // Also try immediate execution (in case DOM is already loaded)
    console.log('Checking if DOM is already loaded...');
    if (document.readyState === 'loading') {
        console.log('DOM is still loading, waiting for DOMContentLoaded...');
    } else {
        console.log('DOM already loaded, setting up listeners immediately...');
        const itemCards = document.querySelectorAll('.item-card');
        console.log('Found', itemCards.length, 'item cards (immediate)');

        itemCards.forEach(function (card, index) {
            const itemId = card.getAttribute('data-item-id');
            console.log(`Card ${index} (immediate): itemId = ${itemId}`);

            card.addEventListener('click', function (e) {
                console.log('=== CARD CLICKED (immediate listener) ===');
                const itemId = parseInt(this.getAttribute('data-item-id'));
                console.log('Parsed itemId:', itemId);

                if (e.target.closest('button[onclick*="openContactModal"]')) {
                    console.log('Clicked on contact button, ignoring...');
                    return;
                }

                if (itemId && window.openItemDetailModal) {
                    console.log('Calling openItemDetailModal with itemId:', itemId);
                    window.openItemDetailModal(itemId);
                } else {
                    console.error('Cannot open modal - itemId:', itemId, 'function exists:', typeof window.openItemDetailModal);
                }
            });
        });
    }

    console.log('=== SCRIPT BLOCK ENDED ===');
</script>
{% endblock %}